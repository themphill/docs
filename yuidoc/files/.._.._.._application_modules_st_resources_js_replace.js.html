<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>../../../application/modules/st/resources/js/replace.js - Sourcetrak</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="Sourcetrak" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/aa.html">aa</a></li>
                                <li><a href="../classes/act_on.html">act_on</a></li>
                                <li><a href="../classes/Collections.Activities.html">Collections.Activities</a></li>
                                <li><a href="../classes/Collections.DomainSets.html">Collections.DomainSets</a></li>
                                <li><a href="../classes/Collections.Locations.html">Collections.Locations</a></li>
                                <li><a href="../classes/Collections.PaginatedActivities.html">Collections.PaginatedActivities</a></li>
                                <li><a href="../classes/Collections.PaginatedLocations.html">Collections.PaginatedLocations</a></li>
                                <li><a href="../classes/Collections.Patterns.html">Collections.Patterns</a></li>
                                <li><a href="../classes/Collections.Pools.html">Collections.Pools</a></li>
                                <li><a href="../classes/Collections.ReplacementNumbers.html">Collections.ReplacementNumbers</a></li>
                                <li><a href="../classes/Collections.Routing.html">Collections.Routing</a></li>
                                <li><a href="../classes/Collections.Schedules.html">Collections.Schedules</a></li>
                                <li><a href="../classes/Collections.SubCollection.html">Collections.SubCollection</a></li>
                                <li><a href="../classes/hubspot.html">hubspot</a></li>
                                <li><a href="../classes/Mixins.AudioFileUploadBtn.html">Mixins.AudioFileUploadBtn</a></li>
                                <li><a href="../classes/Mixins.Autosave.html">Mixins.Autosave</a></li>
                                <li><a href="../classes/Mixins.Autoset.html">Mixins.Autoset</a></li>
                                <li><a href="../classes/Mixins.ClientPagination.html">Mixins.ClientPagination</a></li>
                                <li><a href="../classes/Mixins.HighlightInvalid.html">Mixins.HighlightInvalid</a></li>
                                <li><a href="../classes/Mixins.Loading.html">Mixins.Loading</a></li>
                                <li><a href="../classes/Mixins.Transform.html">Mixins.Transform</a></li>
                                <li><a href="../classes/Models.Activity.html">Models.Activity</a></li>
                                <li><a href="../classes/Models.Location.html">Models.Location</a></li>
                                <li><a href="../classes/Models.Pattern.html">Models.Pattern</a></li>
                                <li><a href="../classes/Models.Pool.html">Models.Pool</a></li>
                                <li><a href="../classes/Models.Routing.html">Models.Routing</a></li>
                                <li><a href="../classes/Models.Schedule.html">Models.Schedule</a></li>
                                <li><a href="../classes/Models.State.html">Models.State</a></li>
                                <li><a href="../classes/Models.SubModel.html">Models.SubModel</a></li>
                                <li><a href="../classes/op.html">op</a></li>
                                <li><a href="../classes/Validator.html">Validator</a></li>
                                <li><a href="../classes/Views.Activity.html">Views.Activity</a></li>
                                <li><a href="../classes/Views.ActivityAdd.html">Views.ActivityAdd</a></li>
                                <li><a href="../classes/Views.ActivityCreate.html">Views.ActivityCreate</a></li>
                                <li><a href="../classes/Views.ActivityDestroy.html">Views.ActivityDestroy</a></li>
                                <li><a href="../classes/Views.ActivityDisplay.html">Views.ActivityDisplay</a></li>
                                <li><a href="../classes/Views.ActivityEdit.html">Views.ActivityEdit</a></li>
                                <li><a href="../classes/Views.ActivityEditAdvanced.html">Views.ActivityEditAdvanced</a></li>
                                <li><a href="../classes/Views.ActivityList.html">Views.ActivityList</a></li>
                                <li><a href="../classes/Views.ActivityPool.html">Views.ActivityPool</a></li>
                                <li><a href="../classes/Views.ActivityPoolEdit.html">Views.ActivityPoolEdit</a></li>
                                <li><a href="../classes/Views.AdvancedOptionsModal.html">Views.AdvancedOptionsModal</a></li>
                                <li><a href="../classes/Views.CopyToClipboard.html">Views.CopyToClipboard</a></li>
                                <li><a href="../classes/Views.DeleteLocationModal.html">Views.DeleteLocationModal</a></li>
                                <li><a href="../classes/Views.Domain.html">Views.Domain</a></li>
                                <li><a href="../classes/Views.DomainSetItem.html">Views.DomainSetItem</a></li>
                                <li><a href="../classes/Views.DomainsPopover.html">Views.DomainsPopover</a></li>
                                <li><a href="../classes/Views.EditPoolToolbar.html">Views.EditPoolToolbar</a></li>
                                <li><a href="../classes/Views.Graph.html">Views.Graph</a></li>
                                <li><a href="../classes/Views.listControls.html">Views.listControls</a></li>
                                <li><a href="../classes/Views.LocationItem.html">Views.LocationItem</a></li>
                                <li><a href="../classes/Views.LocationsList.html">Views.LocationsList</a></li>
                                <li><a href="../classes/Views.Main.html">Views.Main</a></li>
                                <li><a href="../classes/Views.Modal.html">Views.Modal</a></li>
                                <li><a href="../classes/Views.Modal2.html">Views.Modal2</a></li>
                                <li><a href="../classes/Views.ModalPageView.html">Views.ModalPageView</a></li>
                                <li><a href="../classes/Views.Numbers.html">Views.Numbers</a></li>
                                <li><a href="../classes/Views.PageView.html">Views.PageView</a></li>
                                <li><a href="../classes/Views.Poolbar.html">Views.Poolbar</a></li>
                                <li><a href="../classes/Views.PoolsDashboard.html">Views.PoolsDashboard</a></li>
                                <li><a href="../classes/Views.PoolsList.html">Views.PoolsList</a></li>
                                <li><a href="../classes/Views.PoolsListItem.html">Views.PoolsListItem</a></li>
                                <li><a href="../classes/Views.Popover.html">Views.Popover</a></li>
                                <li><a href="../classes/Views.SearchBox.html">Views.SearchBox</a></li>
                                <li><a href="../classes/Views.SnippetModal.html">Views.SnippetModal</a></li>
                                <li><a href="../classes/Views.Toolbar.html">Views.Toolbar</a></li>
                                <li><a href="../classes/Views.VersionHashError.html">Views.VersionHashError</a></li>
                                <li><a href="../classes/Views.Wizard.html">Views.Wizard</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/Carbon.html">Carbon</a></li>
                                <li><a href="../modules/Integration.html">Integration</a></li>
                                <li><a href="../modules/SourceTrak.html">SourceTrak</a></li>
                                <li><a href="../modules/Sourcetrak.html">Sourcetrak</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: ../../../application/modules/st/resources/js/replace.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * @preserve findAndReplaceDOMText v 0.4.1
 * @author James Padolsey http://james.padolsey.com
 * @license http://unlicense.org/UNLICENSE
 */
window._st.replace = (function() {

    var PORTION_MODE_RETAIN = &#x27;retain&#x27;;
    var PORTION_MODE_FIRST = &#x27;first&#x27;;

    var doc = document;
    var toString = {}.toString;

    function isArray(a) {
        return toString.call(a) == &#x27;[object Array]&#x27;;
    }

    function escapeRegExp(s) {
        return String(s).replace(/([.*+?^=!:${}()|[\]\/\\])/g, &#x27;\\$1&#x27;);
    }

    function isNumeric(n) {
      return !isNaN(parseFloat(n)) &amp;&amp; isFinite(n);
    }

    function wrapNode(node, rawNum){
        if (rawNum === undefined || rawNum === null) {
            return;
        }

        var parent = node.parentNode,
            newlink = document.createElement(&#x27;a&#x27;);

        newlink.setAttribute(&#x27;href&#x27;, &#x27;tel:+1&#x27; + rawNum);

        // Set a data attribute on this node that lets us know WE wrapped it in an anchore tag
        newlink.setAttribute(&#x27;data-st-wn&#x27;, &#x27;&#x27;);

        // Set the wrapper as child (instead of the element)
        parent.replaceChild(newlink, node);

        // Set element as child of wrapper
        newlink.appendChild(node);
    }

    function exposed() {
        // Try deprecated arg signature first:
        return deprecated.apply(null, arguments) || findAndReplaceDOMText.apply(null, arguments);
    }

    function deprecated(regex, node, replacement, captureGroup, elFilter) {
        if ((node &amp;&amp; !node.nodeType) &amp;&amp; arguments.length &lt;= 2) {
            return false;
        }
        var isReplacementFunction = typeof replacement == &#x27;function&#x27;;

        if (isReplacementFunction) {
            replacement = (function(original) {
                return function(portion, match) {
                    return original(portion.text, match.startIndex);
                };
            }(replacement));
        }

        // Awkward support for deprecated argument signature (&lt;0.4.0)
        var instance = findAndReplaceDOMText(node, {

            find: regex,

            wrap: isReplacementFunction ? null : replacement,
            replace: isReplacementFunction ? replacement : &#x27;$&#x27; + (captureGroup || &#x27;&amp;&#x27;),

            prepMatch: function(m, mi) {

                // Support captureGroup (a deprecated feature)

                if (!m[0]) throw &#x27;findAndReplaceDOMText cannot handle zero-length matches&#x27;;

                if (captureGroup &gt; 0) {
                    var cg = m[captureGroup];
                    m.index += m[0].indexOf(cg);
                    m[0] = cg;
                }

                m.endIndex = m.index + m[0].length;
                m.startIndex = m.index;
                m.index = mi;

                return m;
            },
            filterElements: elFilter
        });

        exposed.revert = function() {
            return instance.revert();
        };

        return true;
    }

    /**
     * findAndReplaceDOMText
     *
     * Locates matches and replaces with replacementNode
     *
     * @param {Node} node Element or Text node to search within
     * @param {RegExp} options.find The regular expression to match
     * @param {String|Element} [options.wrap] A NodeName, or a Node to clone
     * @param {String|Function} [options.replace=&#x27;$&amp;&#x27;] What to replace each match with
     * @param {Function} [options.filterElements] A Function to be called to check whether to
     *  process an element. (returning true = process element,
     *  returning false = avoid element)
     */
    function findAndReplaceDOMText(node, options) {
        return new Finder(node, options);
    }

    exposed.Finder = Finder;

    /**
     * Finder -- encapsulates logic to find and replace.
     */
    function Finder(node, options) {

        options.portionMode = options.portionMode || PORTION_MODE_RETAIN;

        this.node = node;
        this.options = options;

        // ENable match-preparation method to be passed as option:
        this.prepMatch = options.prepMatch || this.prepMatch;

        this.reverts = [];

        this.matches = this.search();

        if (this.matches.length) {
            this.processMatches();
        }

    }

    Finder.prototype = {

        /**
         * Searches for all matches that comply with the instance&#x27;s &#x27;match&#x27; option
         */
        search: function() {

            var match;
            var matchIndex = 0;
            var regex = this.options.find;
            var text = this.getAggregateText();
            var matches = [];

            regex = typeof regex === &#x27;string&#x27; ? RegExp(escapeRegExp(regex), &#x27;g&#x27;) : regex;

            if (regex.global) {
                while (match = regex.exec(text)) {
                    matches.push(this.prepMatch(match, matchIndex++));
                }
            } else {
                if (match = text.match(regex)) {
                    matches.push(this.prepMatch(match, 0));
                }
            }

            return matches;

        },

        /**
         * Prepares a single match with useful meta info:
         */
        prepMatch: function(match, matchIndex) {

            if (!match[0]) {
                throw new Error(&#x27;findAndReplaceDOMText cannot handle zero-length matches&#x27;);
            }

            match.endIndex = match.index + match[0].length;
            match.startIndex = match.index;
            match.index = matchIndex;

            return match;
        },

        /**
         * Gets aggregate text within subject node
         */
        getAggregateText: function() {

            var elementFilter = this.options.filterElements;

            return getText(this.node);

            /**
             * Gets aggregate text of a node without resorting
             * to broken innerText/textContent
             */
            function getText(node) {

                if (node.nodeType === 3) {
                    return node.data;
                }

                if (elementFilter &amp;&amp; !elementFilter(node)) {
                    return &#x27;&#x27;;
                }

                var txt = &#x27;&#x27;;

                if (node = node.firstChild) do {
                    txt += getText(node);
                } while (node = node.nextSibling);

                return txt;

            }

        },

        /**
         * Steps through the target node, looking for matches, and
         * calling replaceFn when a match is found.
         */
        processMatches: function() {

            var matches = this.matches;
            var node = this.node;
            var elementFilter = this.options.filterElements;

            var startPortion,
                endPortion,
                innerPortions = [],
                curNode = node,
                match = matches.shift(),
                atIndex = 0, // i.e. nodeAtIndex
                matchIndex = 0,
                portionIndex = 0,
                doAvoidNode;

            out: while (true) {

                if (curNode.nodeType === 3) {

                    if (!endPortion &amp;&amp; curNode.length + atIndex &gt;= match.endIndex) {

                        // We&#x27;ve found the ending
                        endPortion = {
                            node: curNode,
                            index: portionIndex++,
                            text: curNode.data.substring(match.startIndex - atIndex, match.endIndex - atIndex),
                            indexInMatch: atIndex - match.startIndex,
                            indexInNode: match.startIndex - atIndex, // always zero for end-portions
                            endIndexInNode: match.endIndex - atIndex,
                            isEnd: true
                        };

                    } else if (startPortion) {
                        // Intersecting node
                        innerPortions.push({
                            node: curNode,
                            index: portionIndex++,
                            text: curNode.data,
                            indexInMatch: atIndex - match.startIndex,
                            indexInNode: 0 // always zero for inner-portions
                        });
                    }

                    if (!startPortion &amp;&amp; curNode.length + atIndex &gt; match.startIndex) {
                        // We&#x27;ve found the match start
                        startPortion = {
                            node: curNode,
                            index: portionIndex++,
                            indexInMatch: 0,
                            indexInNode: match.startIndex - atIndex,
                            endIndexInNode: match.endIndex - atIndex,
                            text: curNode.data.substring(match.startIndex - atIndex, match.endIndex - atIndex)
                        };
                    }

                    atIndex += curNode.data.length;

                }

                doAvoidNode = curNode.nodeType === 1 &amp;&amp; elementFilter &amp;&amp; !elementFilter(curNode);

                if (startPortion &amp;&amp; endPortion) {

                    curNode = this.replaceMatch(match, startPortion, innerPortions, endPortion);

                    // processMatches has to return the node that replaced the endNode
                    // and then we step back so we can continue from the end of the
                    // match:

                    atIndex -= (endPortion.node.data.length - endPortion.endIndexInNode);

                    startPortion = null;
                    endPortion = null;
                    innerPortions = [];
                    match = matches.shift();
                    portionIndex = 0;
                    matchIndex++;

                    if (!match) {
                        break; // no more matches
                    }

                } else if (
                    !doAvoidNode &amp;&amp;
                    (curNode.firstChild || curNode.nextSibling)
                ) {
                    // Move down or forward:
                    curNode = curNode.firstChild || curNode.nextSibling;
                    continue;
                }

                // Move forward or up:
                while (true) {
                    if (curNode.nextSibling) {
                        curNode = curNode.nextSibling;
                        break;
                    } else if (curNode.parentNode !== node) {
                        curNode = curNode.parentNode;
                    } else {
                        break out;
                    }
                }

            }

        },

        /**
         * Reverts ... TODO
         */
        revert: function() {
            // Reversion occurs backwards so as to avoid nodes subsequently
            // replaced during the matching phase (a forward process):
            for (var l = this.reverts.length; l--;) {
                this.reverts[l]();
            }
            this.reverts = [];
        },

        prepareReplacementString: function(string, portion, match, matchIndex) {
            var portionMode = this.options.portionMode;
            if (
                portionMode === PORTION_MODE_FIRST &amp;&amp;
                portion.indexInMatch &gt; 0
            ) {
                return &#x27;&#x27;;
            }
            string = string.replace(/\$(\d+|&amp;|&#x60;|&#x27;)/g, function($0, t) {
                var replacement;
                switch(t) {
                    case &#x27;&amp;&#x27;:
                        replacement = match[0];
                        break;
                    case &#x27;&#x60;&#x27;:
                        replacement = match.input.substring(0, match.startIndex);
                        break;
                    case &#x27;\&#x27;&#x27;:
                        replacement = match.input.substring(match.endIndex);
                        break;
                    default:
                        replacement = match[+t];
                }
                return replacement;
            });

            if (portionMode === PORTION_MODE_FIRST) {
                return string;
            }

            if (portion.isEnd) {
                return string.substring(portion.indexInMatch);
            }

            return string.substring(portion.indexInMatch, portion.indexInMatch + portion.text.length);
        },

        getPortionReplacementNode: function(portion, match, matchIndex) {

            var replacement = this.options.replace || &#x27;$&amp;&#x27;;
            var wrapper = this.options.wrap;

            if (wrapper &amp;&amp; wrapper.nodeType) {
                // Wrapper has been provided as a stencil-node for us to clone:
                var clone = doc.createElement(&#x27;div&#x27;);
                clone.innerHTML = wrapper.outerHTML || new XMLSerializer().serializeToString(wrapper);
                wrapper = clone.firstChild;
            }

            if (typeof replacement == &#x27;function&#x27;) {
                replacement = replacement(portion, match, matchIndex);
                if (replacement &amp;&amp; replacement.nodeType) {
                    return replacement;
                }
                return doc.createTextNode(String(replacement));
            }

            var el = typeof wrapper == &#x27;string&#x27; ? doc.createElement(wrapper) : wrapper;

            replacement = doc.createTextNode(
                this.prepareReplacementString(
                    replacement, portion, match, matchIndex
                )
            );

            if (!replacement.data) {
                return replacement;
            }

            if (!el) {
                return replacement;
            }

            el.appendChild(replacement);

            return el;
        },

        replaceMatch: function(match, startPortion, innerPortions, endPortion) {

            var matchStartNode = startPortion.node;
            var matchEndNode = endPortion.node;

            var preceedingTextNode;
            var followingTextNode;

            if (matchStartNode === matchEndNode) {

                var node = matchStartNode;

                if (startPortion.indexInNode &gt; 0) {
                    // Add &#x60;before&#x60; text node (before the match)
                    preceedingTextNode = doc.createTextNode(node.data.substring(0, startPortion.indexInNode));
                    node.parentNode.insertBefore(preceedingTextNode, node);
                }

                // Create the replacement node:
                var newNode = this.getPortionReplacementNode(
                    endPortion,
                    match
                );

                node.parentNode.insertBefore(newNode, node);

                if (this.options.wrapInATag){
                    wrapNode(newNode, this.options.rawNum);
                }

                if (endPortion.endIndexInNode &lt; node.length) { // ?????
                    // Add &#x60;after&#x60; text node (after the match)
                    followingTextNode = doc.createTextNode(node.data.substring(endPortion.endIndexInNode));
                    node.parentNode.insertBefore(followingTextNode, node);
                }

                node.parentNode.removeChild(node);

                this.reverts.push(function() {
                    if (preceedingTextNode === newNode.previousSibling) {
                        preceedingTextNode.parentNode.removeChild(preceedingTextNode);
                    }
                    if (followingTextNode === newNode.nextSibling) {
                        followingTextNode.parentNode.removeChild(followingTextNode);
                    }
                    newNode.parentNode.replaceChild(node, newNode);
                });

                return newNode;

            } else {
                // Replace matchStartNode -&gt; [innerMatchNodes...] -&gt; matchEndNode (in that order)


                preceedingTextNode = doc.createTextNode(
                    matchStartNode.data.substring(0, startPortion.indexInNode)
                );

                followingTextNode = doc.createTextNode(
                    matchEndNode.data.substring(endPortion.endIndexInNode)
                );

                var firstNode = this.getPortionReplacementNode(
                    startPortion,
                    match
                );

                var innerNodes = [];

                for (var i = 0, l = innerPortions.length; i &lt; l; ++i) {
                    var portion = innerPortions[i];
                    var innerNode = this.getPortionReplacementNode(
                        portion,
                        match
                    );
                    portion.node.parentNode.replaceChild(innerNode, portion.node);
                    // if on mobile device and the node we are on contains the middle part of the phone number wrap it in an a tag
                    if (this.options.wrapInATag
                        &amp;&amp; (isNumeric(innerNode.textContent)
                            || innerNode.textContent.indexOf(stInfo.stn.substr(3, 3)) &gt; -1)) {
                        wrapNode(innerNode, this.options.rawNum);
                    }
                    this.reverts.push((function(portion, innerNode) {
                        return function() {
                            innerNode.parentNode.replaceChild(portion.node, innerNode);
                        };
                    }(portion, innerNode)));
                    innerNodes.push(innerNode);
                }

                var lastNode = this.getPortionReplacementNode(
                    endPortion,
                    match
                );

                matchStartNode.parentNode.insertBefore(preceedingTextNode, matchStartNode);
                matchStartNode.parentNode.insertBefore(firstNode, matchStartNode);
                matchStartNode.parentNode.removeChild(matchStartNode);

                matchEndNode.parentNode.insertBefore(lastNode, matchEndNode);
                matchEndNode.parentNode.insertBefore(followingTextNode, matchEndNode);
                matchEndNode.parentNode.removeChild(matchEndNode);

                // if mobile wrap the elements in a tags
                if (this.options.wrapInATag){
                    wrapNode(firstNode, this.options.rawNum);
                    wrapNode(lastNode, this.options.rawNum);
                }

                this.reverts.push(function() {
                    preceedingTextNode.parentNode.removeChild(preceedingTextNode);
                    firstNode.parentNode.replaceChild(matchStartNode, firstNode);
                    followingTextNode.parentNode.removeChild(followingTextNode);
                    lastNode.parentNode.replaceChild(matchEndNode, lastNode);
                });

                return lastNode;
            }
        }

    };

    return exposed;

}());

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
