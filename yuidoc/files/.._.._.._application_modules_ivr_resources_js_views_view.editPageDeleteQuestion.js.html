<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>../../../application/modules/ivr/resources/js/views/view.editPageDeleteQuestion.js - Sourcetrak</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="Sourcetrak" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/aa.html">aa</a></li>
                                <li><a href="../classes/act_on.html">act_on</a></li>
                                <li><a href="../classes/Collections.Activities.html">Collections.Activities</a></li>
                                <li><a href="../classes/Collections.DomainSets.html">Collections.DomainSets</a></li>
                                <li><a href="../classes/Collections.Locations.html">Collections.Locations</a></li>
                                <li><a href="../classes/Collections.PaginatedActivities.html">Collections.PaginatedActivities</a></li>
                                <li><a href="../classes/Collections.PaginatedLocations.html">Collections.PaginatedLocations</a></li>
                                <li><a href="../classes/Collections.Patterns.html">Collections.Patterns</a></li>
                                <li><a href="../classes/Collections.Pools.html">Collections.Pools</a></li>
                                <li><a href="../classes/Collections.ReplacementNumbers.html">Collections.ReplacementNumbers</a></li>
                                <li><a href="../classes/Collections.Routing.html">Collections.Routing</a></li>
                                <li><a href="../classes/Collections.Schedules.html">Collections.Schedules</a></li>
                                <li><a href="../classes/Collections.SubCollection.html">Collections.SubCollection</a></li>
                                <li><a href="../classes/hubspot.html">hubspot</a></li>
                                <li><a href="../classes/Mixins.AudioFileUploadBtn.html">Mixins.AudioFileUploadBtn</a></li>
                                <li><a href="../classes/Mixins.Autosave.html">Mixins.Autosave</a></li>
                                <li><a href="../classes/Mixins.Autoset.html">Mixins.Autoset</a></li>
                                <li><a href="../classes/Mixins.ClientPagination.html">Mixins.ClientPagination</a></li>
                                <li><a href="../classes/Mixins.HighlightInvalid.html">Mixins.HighlightInvalid</a></li>
                                <li><a href="../classes/Mixins.Loading.html">Mixins.Loading</a></li>
                                <li><a href="../classes/Mixins.Transform.html">Mixins.Transform</a></li>
                                <li><a href="../classes/Models.Activity.html">Models.Activity</a></li>
                                <li><a href="../classes/Models.Location.html">Models.Location</a></li>
                                <li><a href="../classes/Models.Pattern.html">Models.Pattern</a></li>
                                <li><a href="../classes/Models.Pool.html">Models.Pool</a></li>
                                <li><a href="../classes/Models.Routing.html">Models.Routing</a></li>
                                <li><a href="../classes/Models.Schedule.html">Models.Schedule</a></li>
                                <li><a href="../classes/Models.State.html">Models.State</a></li>
                                <li><a href="../classes/Models.SubModel.html">Models.SubModel</a></li>
                                <li><a href="../classes/op.html">op</a></li>
                                <li><a href="../classes/Validator.html">Validator</a></li>
                                <li><a href="../classes/Views.Activity.html">Views.Activity</a></li>
                                <li><a href="../classes/Views.ActivityAdd.html">Views.ActivityAdd</a></li>
                                <li><a href="../classes/Views.ActivityCreate.html">Views.ActivityCreate</a></li>
                                <li><a href="../classes/Views.ActivityDestroy.html">Views.ActivityDestroy</a></li>
                                <li><a href="../classes/Views.ActivityDisplay.html">Views.ActivityDisplay</a></li>
                                <li><a href="../classes/Views.ActivityEdit.html">Views.ActivityEdit</a></li>
                                <li><a href="../classes/Views.ActivityEditAdvanced.html">Views.ActivityEditAdvanced</a></li>
                                <li><a href="../classes/Views.ActivityList.html">Views.ActivityList</a></li>
                                <li><a href="../classes/Views.ActivityPool.html">Views.ActivityPool</a></li>
                                <li><a href="../classes/Views.ActivityPoolEdit.html">Views.ActivityPoolEdit</a></li>
                                <li><a href="../classes/Views.AdvancedOptionsModal.html">Views.AdvancedOptionsModal</a></li>
                                <li><a href="../classes/Views.CopyToClipboard.html">Views.CopyToClipboard</a></li>
                                <li><a href="../classes/Views.DeleteLocationModal.html">Views.DeleteLocationModal</a></li>
                                <li><a href="../classes/Views.DomainSetItem.html">Views.DomainSetItem</a></li>
                                <li><a href="../classes/Views.DomainsPopover.html">Views.DomainsPopover</a></li>
                                <li><a href="../classes/Views.EditPoolToolbar.html">Views.EditPoolToolbar</a></li>
                                <li><a href="../classes/Views.Graph.html">Views.Graph</a></li>
                                <li><a href="../classes/Views.listControls.html">Views.listControls</a></li>
                                <li><a href="../classes/Views.LocationItem.html">Views.LocationItem</a></li>
                                <li><a href="../classes/Views.LocationsList.html">Views.LocationsList</a></li>
                                <li><a href="../classes/Views.Main.html">Views.Main</a></li>
                                <li><a href="../classes/Views.Modal.html">Views.Modal</a></li>
                                <li><a href="../classes/Views.Modal2.html">Views.Modal2</a></li>
                                <li><a href="../classes/Views.ModalPageView.html">Views.ModalPageView</a></li>
                                <li><a href="../classes/Views.Numbers.html">Views.Numbers</a></li>
                                <li><a href="../classes/Views.PageView.html">Views.PageView</a></li>
                                <li><a href="../classes/Views.Poolbar.html">Views.Poolbar</a></li>
                                <li><a href="../classes/Views.PoolsDashboard.html">Views.PoolsDashboard</a></li>
                                <li><a href="../classes/Views.PoolsList.html">Views.PoolsList</a></li>
                                <li><a href="../classes/Views.PoolsListItem.html">Views.PoolsListItem</a></li>
                                <li><a href="../classes/Views.Popover.html">Views.Popover</a></li>
                                <li><a href="../classes/Views.SearchBox.html">Views.SearchBox</a></li>
                                <li><a href="../classes/Views.SnippetModal.html">Views.SnippetModal</a></li>
                                <li><a href="../classes/Views.Toolbar.html">Views.Toolbar</a></li>
                                <li><a href="../classes/Views.VersionHashError.html">Views.VersionHashError</a></li>
                                <li><a href="../classes/Views.Wizard.html">Views.Wizard</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/Carbon.html">Carbon</a></li>
                                <li><a href="../modules/Integration.html">Integration</a></li>
                                <li><a href="../modules/SourceTrak.html">SourceTrak</a></li>
                                <li><a href="../modules/Sourcetrak.html">Sourcetrak</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: ../../../application/modules/ivr/resources/js/views/view.editPageDeleteQuestion.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
 Ibp.Survey.Views.EditPageDeleteQuestion = Ibp.Carbon.Views.Modal.extend({
    template: Ibp.Survey.Templates.editPageDeleteQuestion,
    conflictTemplate: Ibp.Survey.Templates.editPageDeleteQuestionConflict,
    textAreaTemplate: Ibp.Survey.Templates.editPageDeleteQuestionPromptTextArea,
    nextActionList: null,
    conflicts: null,
    netgetParamConflicts: null,

    events: {
        &#x27;click #confirm&#x27;: &#x27;confirm&#x27;,
        &#x27;click #cancel&#x27;: &#x27;cancel&#x27;,
        &#x27;hidden&#x27;: &#x27;unrender&#x27;
    },

    subscriptions: {
        &#x27;notification:modal:error&#x27;: &#x27;notify&#x27;
    },

    init : function (options) {

        if(this.options.model.isSaving){
            this.subscriptions[&#x27;change:questionSaved&#x27;] = &#x27;reInit&#x27;;
            this.prevOptions = options;
        } else {
            var _this = this,
                q = null;

            options = this.prevOptions || options;
            this.unSubscribe(&#x27;change:questionSaved&#x27;);

            this.model = options.model;
            this.qId   = options.qId;

            q = this.model.getFlatQuestion(this.qId)
            this.qNumber      = q.question_number;
            this.questionName = q.question_number + &quot;. &quot; + q.label;

            this.$el = $(&#x27;&lt;div class=&quot;modal hide overflow-modal&quot; id=&quot;survey-modal&quot;&gt;&lt;/div&gt;&#x27;);
            this.render();

            this.conflicts = []
            this.netgetParamConflicts = [];

            this.$el.html(this.template({
                questionName: Ibp.Utils.truncate(this.questionName, 50),
                conflicts: this.conflicts,
                netgetParamConflicts: this.netgetParamConflicts
            }));
            // add a class to the modal body to turn on overflow-y scroll
            this.$el.find(&#x27;.modal-body&#x27;).addClass(&#x27;overflow-scroll&#x27;);

            // determine if this question has dependencies
            _.each(this.model.attributes.questions, function(q, i, list) {

                var c = _this.getQuestionDependencies(q, _this.qNumber);
                _.each(c, function (con) {
                    if (typeof(_this.conflicts[con._id]) == &#x27;undefined&#x27;) {
                        _this.conflicts[con._id] = {nextActions: [], ttsTokens: {}};
                    }
                    _this.conflicts[con._id].nextActions.push(con);
                });

                var tts = _this.getQuestionTTSDependencies(q, _this.qNumber);
                if (tts !== false) {
                    if (typeof(_this.conflicts[q._id]) == &#x27;undefined&#x27;) {
                        _this.conflicts[q._id] = {nextActions: [], ttsTokens: {}};
                    }
                    _this.conflicts[q._id].ttsTokens = tts;
                }
            });

            // check the survey netget params for dependencies on this question
            var params = this.model.get(&#x27;post_survey_actions.netget.params&#x27;),
                ngc = this.model.getQuestionNetgetDependencies(params, _this.qNumber);

            this.netgetParamConflicts = this.netgetParamConflicts.concat(ngc);

            if (this.conflicts.length) {
                // only show the conflict resolution div if conflicts exist
                _this.$el.find(&#x27;.delete-question-conflicts&#x27;).show();
            }

            if (this.netgetParamConflicts.length) {

                if (this.netgetParamConflicts.length &gt; 1) {
                    _this.$el.find(&#x27;.pluralParameter&#x27;).html(&quot;parameters are&quot;);
                }
                // only show the netget params conflict div if conflicts exist
                _this.$el.find(&#x27;.delete-question-netget-param-conflicts&#x27;).show();
            }

            // setup the various conflict views within the modal
            this.nextActionList = [];

            // loop through the dependencies rendering the required elements in the modal
            _.each(this.conflicts, function (conflicts) {
                var $row;

                // if we have next action conflicts create those elements
                _.each(conflicts.nextActions, function (na) {
                    // this is the ID we will use later to update the modal when conflicts are resolved
                    var elemId = &quot;modal-conflict-item-nextAction-&quot; + na._id;

                    if (na.choiceId) {
                        elemId = elemId + &quot;-&quot; + na.choiceId;
                    }

                    if (typeof $row == &quot;undefined&quot;) {
                        $row = $(_this.conflictTemplate(na));
                    }

                    // add a div to the list for this next action to live in
                    $row.find(&#x27;.c-next-action&#x27;).append(&quot;&lt;div id=&#x27;&quot; + elemId + &quot;&#x27; class=&#x27;nextActionItem c-item-row&#x27;&gt;&lt;/div&gt;&quot;);
                    _this.nextActionList.push(new Ibp.Survey.Views.NextAction({
                        model: _this.model,
                        container: $($row.find(&#x27;.c-next-action .nextActionItem:last&#x27;)),
                        qId: na._id,
                        labelTop: false,
                        labelLeft: false,
                        choiceId: na.choiceId
                    }));

                    // show the next action container now that it has at least one item in it
                    $row.find(&#x27;.c-next-action&#x27;).show();
                    
                    // if this conflict is from an answer choice, insert the label before the next action view
                    if (na.question_number_with_choice) {
                        $row.find(&#x27;.c-next-action .nextActionItem:last&#x27;).prepend(&quot;&lt;span class=&#x27;c-number&#x27;&gt;&quot; + na.question_number_with_choice + &quot;.&lt;/span&gt;&quot;);
                    }

                    _this.listenTo(_this.model, &#x27;change:questionSaved-&#x27; + na._id, _this.updateModalConflicts);
                });

                // if we have a tts token conflict than render the modal element
                if (conflicts.ttsTokens._id) {
                    // this is the ID we will use later to update the modal when conflicts are resolved
                    var elemId = &quot;modal-conflict-item-tts-&quot; + conflicts.ttsTokens._id,
                        data = {
                            path: &#x27;say&#x27;,
                            _id: conflicts.ttsTokens._id,
                            script: conflicts.ttsTokens.script
                        },
                        html = _this.textAreaTemplate(data);

                    if (typeof $row == &quot;undefined&quot;) {
                        $row = $(_this.conflictTemplate(conflicts.ttsTokens));
                    }

                    $row.find(&#x27;.c-tts-token .ttsTextArea&#x27;).html(html).attr(&#x27;id&#x27;, elemId);
                    // show the tts tokens container now that it has at least one item in it
                    $row.find(&#x27;.c-tts-token&#x27;).show();
                }

                $row.find(&#x27;.next-action .chosen-action&#x27;).addClass(&#x27;highlighted&#x27;);
                $row.find(&#x27;.next-action .dropdown-btn&#x27;).addClass(&#x27;highlighted&#x27;);
                // append the compiled conflict row to the main container
                _this.$el.find(&#x27;.resolvable-conflicts-list&#x27;).show().append($row);
            });

            var toAppend = [];
            _.each(this.netgetParamConflicts, function (con) {
                // loop through the netget param conflicts inserting rows into the list element
                toAppend.push($(Ibp.Survey.Templates.editPageDeleteQuestionNetgetConflict(con)))
            });
            _this.$el.find(&#x27;.delete-question-netget-param-conflict-list&#x27;).append(toAppend);
        }
    },

    reInit: function() {
        this.init();
        this.delegateEvents();
    },

    /**
     *  Scans an individual question to determine if it is dependent on the given question number
     *  question - question object from a survey model
     *  qNumber - relative question number to investigate (not the database primary key)
     *  choiceId - if the dependency check should only run on a single choice, specify the id with this parameter
     *  return - an array of conflict objects
     */
    getQuestionDependencies : function(question, qNumber, choiceId) {
        var c = [];
        choiceId = typeof choiceId !== &#x27;undefined&#x27; ? choiceId : null;

        // check the next-action of the question to see if it is a &quot;goto&quot; action
        if (question._body.action.type == &quot;goto&quot;) {

            // see if the target question is the one being investigated
            if (question._body.action.where == qNumber) {
                c.push({
                    _id: question._body._id,
                    question_number: question._body.question_number,
                    label: question._body.label,
                    resolved: false,
                    choiceId: null
                });
            }
        } else if (question._body.action.type == &quot;depends_on_response&quot;) {

            // check to see if the depends-on-result action of any multiple choice answers is the relevant question
            var choices = question._body.capture.choices;

            _.each(choices, function (choice) {
                if ((!choiceId || choice._id == choiceId)
                    &amp;&amp; choice._body.action.type == &quot;goto&quot;
                    &amp;&amp; choice._body.action.where == qNumber) {
                    c.push({
                        _id: question._body._id,
                        question_number: question._body.question_number,
                        question_number_with_choice: question._body.question_number + &#x27;.&#x27; + choice._body.answer_number,
                        label: question._body.label,
                        resolved: false,
                        choiceId: choice._id
                    });
                }
            });
        }
        return c;
    },

    /**
     * Scan the prompt text of the question to see if the given question number is used in a TTS token
     * question - question object from a survey model
     * qNumber - relative question number to investigate (not the database primary key)
     * return - a single conflict object, if one exists. otherwise false
     */
    getQuestionTTSDependencies : function(question, qNumber) {
        var con = false,
            target = &quot;@ivrq&quot; + qNumber;

        if (question._body.say.script.toLowerCase().indexOf(target) != -1) {
            con = {
                _id: question._body._id,
                question_number: question._body.question_number,
                label: question._body.label,
                resolved: false,
                script: question._body.say.script
            };
        }

        return con;
    },

    updateModalConflicts : function() {
        var _this = this;

        // loop through the conflicts to see what was fixed
        _.each(this.conflicts, function (c) {

            // check each of the &quot;next action&quot; conflicts for this question&#x27;s conflicts
            _.each(c.nextActions, function(na) {

                var q = _this.model.getQuestion(na._id),
                    idString = na.choiceId ? na._id + &quot;-&quot; + na.choiceId : na._id,
                    $conflict = $(&#x27;#modal-conflict-item-nextAction-&#x27; + idString),
                    remainingConflicts = _this.getQuestionDependencies(q, _this.qNumber, na.choiceId);

                // if there is no conflict, remove the highlighting for that question conflict row
                if (!remainingConflicts.length) {
                    $conflict.find(&#x27;.highlighted&#x27;).removeClass(&#x27;highlighted&#x27;);
                    // remove the conflict from the array, as it has been resolved
                    na.resolved = true;
                } else {
                    // there is still a conflict, so make sure the relevant elements are highlighted
                    $conflict.find(&#x27;.chosen-action&#x27;).addClass(&#x27;highlighted&#x27;);
                    $conflict.find(&#x27;.dropdown-btn&#x27;).addClass(&#x27;highlighted&#x27;);
                    na.resolved = false;
                }

            });
            // also check the tts token dependencies for this question
            if (c.ttsTokens._id) {

                var tts = c.ttsTokens,
                    q = _this.model.getQuestion(tts._id),
                    $conflict = $(&#x27;#modal-conflict-item-tts-&#x27; + tts._id);
                    q._body.say.script = $conflict.find(&#x27;textarea&#x27;).val(),
                    remainingConflict = _this.getQuestionTTSDependencies(q, _this.qNumber);
                    
                // if there is no conflict, remove the highlighting for that question conflict row
                if (remainingConflict === false) {
                    $conflict.find(&#x27;.highlighted&#x27;).removeClass(&#x27;highlighted&#x27;);
                    // remove the conflict from the array, as it has been resolved
                    tts.resolved = true;
                } else {
                    // there is still a conflict, so make sure the relevant elements are highlighted
                    $conflict.find(&#x27;textarea&#x27;).addClass(&#x27;highlighted&#x27;);
                    tts.resolved = false;
                }

            }
        });

    },

    confirm: function () {
        this.updateModalConflicts();
        var valid = true;

        _.each(this.conflicts, function (con) {
            _.each(con.nextActions, function (na) {
                if (na.resolved == false) {
                    valid = false;
                }
            });
            if (con.ttsTokens._id &amp;&amp; con.ttsTokens.resolved == false) {
                valid = false;
            } 
        });

        if (!valid) {
            return false;
        }

        // fire a kiss metrics event indicating the delete modal was used
        Ibp.Kissmetrics.push([&#x27;record&#x27;, &#x27;ivr_Clicked confirm for IVR delete question modal&#x27;]);
        this.saveUpdatedQuestionScript();
        this.model.deleteQuestion(this.qId);
        this.cleanupNextActions();
        this.unrender();
    },

    saveUpdatedQuestionScript: function () {
        var _this = this,
            model = this.model,
            attr = { questions: [] },
            message;

        _.each(this.conflicts, function (con) {
            if (con.ttsTokens._id) {

                var tts = con.ttsTokens,
                    textArea = $(&#x27;#modal-conflict-item-tts-&#x27; + tts._id + &#x27; textarea&#x27;),
                    newVal = textArea.val(),
                    dataPart = {
                        _id: tts._id,
                        _body: {
                            say: {
                                script: newVal
                            }
                        }
                    };

                attr.questions.push(dataPart);
            }
        });

        model.isSaving = true;
        model.save(attr, {
            patch: true,
            silent: true,
            validate: true,
            success: function() {
                model.isSaving = false;
                model.trigger(&#x27;saved&#x27;);
                _this.publish(&#x27;change:modelUpdated&#x27; + model.id, model);
            },
            error: function () {
                model.isSaving = false;

                message = model.makeNotificationMessage(&#x27;question message&#x27;, &#x27;error&#x27;);
                _this.publish(&#x27;notify&#x27;, {type: &#x27;save:error&#x27;, msg: message});
            }
        });
    },

    cleanupNextActions : function () {
        // clean up the old next actions
        _.each(this.nextActionList, function(na) {
            na.remove();
        });
    }
 });

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
